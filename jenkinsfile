pipeline {
    
    agent {
	    label 'agent1'
    }
    

    environment {
	    def btime="${BUILD_TIMESTAMP}"
	    GIT_COMMIT_HASH = sh (script: "git log -n 1 --pretty=format:'%H'", returnStdout: true) 
	    SHORT_COMMIT = "${GIT_COMMIT_HASH[0..7]}"
            BRANCH = "${env.gitlabBranch}"
	    DOCKER_IMAGE_NAME = "bm-app:${SHORT_COMMIT}"
            GITHUB_REPO = "yisraelberman/escape-room"
            GITHUB_TOKEN = credentials('github-token')
            GITHUB_USER = credentials('github-user')

    }


    stages {
        // TODO add test
		stage('test'){
			steps {
				echo 'To be added someday. '
			

			}
		}
        
        stage('Build') {
            steps {
                sh "docker build -t ${DOCKER_IMAGE_NAME} -f ./escape_room-Q-order/dockerfile ./escape_room-Q-order"
            }
        }

        stage('Docker Login') {
            steps {
                sh "echo ${GITHUB_TOKEN} | docker login ghcr.io -u ${GITHUB_USER} --password-stdin"
            }
        }

        stage('Push Image to GitHub') {
            steps {
                sh "docker tag ${DOCKER_IMAGE_NAME} ghcr.io/${GITHUB_REPO}:${SHORT_COMMIT}"
                sh "docker push ghcr.io/${GITHUB_REPO}:${SHORT_COMMIT}"
                sh "docker tag ${DOCKER_IMAGE_NAME} ghcr.io/${GITHUB_REPO}:latest"
                sh "docker push ghcr.io/${GITHUB_REPO}:latest"
            }
        }

        stage('deploy'){
			steps {
				script{
                	withCredentials([file(credentialsId: 'forssh', variable: 'secret')]) {
						script {
                            sh 'ssh -i "$secret" ubuntu@44.202.106.141 "sudo docker run -d --name bm-app ghcr.io/yisraelberman/escape-room:latest"'
							
						}
            		}
            	}

			}
		}
    }
    
    
    post {
        always {
            // Clean up the workspace
            cleanWs()
            sh "docker rmi ${DOCKER_IMAGE_NAME} || true"

           
        }
    }
}

